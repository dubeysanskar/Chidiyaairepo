// Prisma Schema for ChidiyaAI Admin and Supplier Portal
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN MODELS
// ============================================

model Admin {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String   // bcrypt hashed
  name          String?
  role          String   @default("admin") // admin, super_admin
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  activityLogs  ActivityLog[]

  @@map("admins")
}

model ActivityLog {
  id          String   @id @default(uuid())
  adminId     String?
  action      String   // approved_supplier, flagged_buyer, etc.
  entityType  String   // supplier, buyer, inquiry
  entityId    String?
  message     String
  createdAt   DateTime @default(now())

  // Relations
  admin       Admin?   @relation(fields: [adminId], references: [id])

  @@map("activity_logs")
}

model AIAlert {
  id          String   @id @default(uuid())
  severity    String   // high, medium, low
  title       String
  description String
  entityType  String?  // supplier, buyer
  entityId    String?
  status      String   @default("active") // active, dismissed, resolved
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  @@map("ai_alerts")
}

model Notification {
  id          String   @id @default(uuid())
  userId      String   // Supplier or Buyer ID
  title       String
  message     String
  type        String   @default("info") // info, success, warning, error
  link        String?  // Optional link to related page
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("notifications")
}

model SystemSettings {
  id        String   @id @default("default")
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ============================================
// SUPPLIER MODELS
// ============================================

model Supplier {
  id                String   @id @default(uuid())
  companyName       String
  email             String   @unique
  password          String   // bcrypt hashed
  phone             String?
  gstNumber         String?
  panNumber         String?
  
  // Business Info
  productCategories String[] // Array of categories
  capacity          String?  // small, medium, large, enterprise
  moq               String?  // Minimum order quantity
  serviceLocations  String?
  
  // Profile Info
  address           String?
  city              String?
  state             String?
  pincode           String?
  website           String?
  profileImage      String?  // URL to profile image
  description       String?
  categories        String?  // Comma separated categories
  establishedYear   String?
  employeeCount     String?
  certifications    String?
  
  // Verification
  status            String   @default("pending") // pending, approved, suspended, banned
  badges            String[] // gst, premium, verified, top_rated, fast_delivery
  suspendedUntil    DateTime? // For time-based suspensions
  documents         SupplierDocument[]
  
  // Email Verification
  emailVerified     Boolean   @default(false)
  verificationOTP   String?
  otpExpiry         DateTime?
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Timestamps
  lastLogin         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Trial Period & Subscription
  trialStartDate     DateTime?  // When trial started (set on approval)
  trialEndDate       DateTime?  // When trial ends (default: 6 months from start)
  subscriptionStatus String     @default("trial") // trial, active, expired, cancelled
  isSubscribed       Boolean    @default(false)
  subscriptionExpiry DateTime?
  razorpayOrderId    String?
  razorpayCustomerId String?    // For auto-pay
  autoPayEnabled     Boolean    @default(false)
  lastPaymentDate    DateTime?
  
  // Relations
  inquiries             Inquiry[]
  quotes                Quote[]
  products              Product[]
  ratings               SupplierRating[]
  supplierCategories    SupplierCategory[]
  trialExtensionRequests TrialExtensionRequest[]
  subscriptions         SubscriptionPayment[]

  @@map("suppliers")
}

// ============================================
// TRIAL EXTENSION & SUBSCRIPTION
// ============================================

model TrialExtensionRequest {
  id              String   @id @default(uuid())
  supplierId      String
  requestedMonths Int      // 1-6 months
  reason          String?  // Why they need extension
  status          String   @default("pending") // pending, approved, rejected
  approvedMonths  Int?     // How many months admin approved
  adminNote       String?  // Admin's response
  approvedBy      String?  // Admin ID
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  // Relations
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  @@index([supplierId])
  @@map("trial_extension_requests")
}

model SubscriptionPayment {
  id                String   @id @default(uuid())
  supplierId        String
  amount            Float
  currency          String   @default("INR")
  planType          String   // monthly, quarterly, yearly
  razorpayPaymentId String?
  razorpayOrderId   String?
  razorpaySignature String?
  status            String   @default("pending") // pending, success, failed
  startDate         DateTime?
  endDate           DateTime?
  autoRenew         Boolean  @default(false)
  createdAt         DateTime @default(now())
  
  // Relations
  supplier          Supplier @relation(fields: [supplierId], references: [id])
  
  @@index([supplierId])
  @@map("subscription_payments")
}

// ============================================
// CATEGORY TEMPLATE (Master categories with specifications)
// ============================================

model CategoryTemplate {
  id              String   @id @default(uuid())
  name            String   @unique
  slug            String   @unique
  description     String?
  image           String?
  specifications  Json     // Array of spec definitions with options
  commonNames     String[] // Common Indian names for chatbot matching
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  supplierCategories SupplierCategory[]
  products           Product[]

  @@map("category_templates")
}

// ============================================
// SUPPLIER CATEGORY (Links supplier to categories)
// ============================================

model SupplierCategory {
  id                String   @id @default(uuid())
  supplierId        String
  categoryTemplateId String?  // Links to CategoryTemplate if exists
  
  // For custom category requests
  customName        String?
  customDescription String?
  customImage       String?
  
  // Status
  status            String   @default("pending") // pending, approved, rejected
  isPrimary         Boolean  @default(false)     // Is this the primary category
  createdAt         DateTime @default(now())
  approvedAt        DateTime?

  // Relations
  supplier          Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  categoryTemplate  CategoryTemplate? @relation(fields: [categoryTemplateId], references: [id])
  products          Product[]

  @@unique([supplierId, categoryTemplateId])
  @@map("supplier_categories")
}

model Product {
  id                  String   @id @default(uuid())
  supplierId          String
  supplierCategoryId  String?
  categoryTemplateId  String?
  
  // Basic Details
  name                String
  description         String?
  price               Float?
  priceUnit           String?  // per Piece, Pack, Kg, Meter, etc.
  
  // Images (up to 5)
  images              String[]
  
  // Specifications (JSON based on category template)
  specifications      Json?
  
  // Legacy fields (for backward compatibility)
  category            String?
  priceRange          String?
  moq                 String?
  leadTime            String?
  
  // Status
  isActive            Boolean  @default(true)
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  supplier            Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierCategory    SupplierCategory? @relation(fields: [supplierCategoryId], references: [id])
  categoryTemplate    CategoryTemplate? @relation(fields: [categoryTemplateId], references: [id])

  @@map("products")
}

model SupplierDocument {
  id          String   @id @default(uuid())
  supplierId  String
  docType     String   // gst_certificate, pan_card, iec, etc.
  fileName    String
  fileUrl     String?
  status      String   @default("pending") // pending, verified, rejected
  createdAt   DateTime @default(now())

  // Relations
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("supplier_documents")
}

// ============================================
// BUYER MODELS
// ============================================

model Buyer {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  phone         String?
  companyName   String?
  password      String?  // bcrypt hashed (added for custom auth)
  
  // Status
  status        String   @default("active") // active, flagged, warned, restricted
  flagged       Boolean  @default(false)
  flagReason    String?
  flagSeverity  String?  // low, medium, high
  
  // Email Verification
  emailVerified     Boolean   @default(false)
  verificationOTP   String?
  otpExpiry         DateTime?
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Stats
  inquiryCount  Int      @default(0)
  
  // Subscription
  isSubscribed       Boolean   @default(false)
  subscriptionExpiry DateTime?
  razorpayOrderId    String?
  dailyQueryCount    Int       @default(0)
  lastQueryDate      DateTime?
  
  // Timestamps
  lastActive    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  inquiries       Inquiry[]
  chatSessions    ChatSession[]
  savedSuppliers  SavedSupplier[]
  contactLogs     SupplierContactLog[]
  ratings         SupplierRating[]

  @@map("buyers")
}


// ============================================
// CHAT MODELS
// ============================================

model ChatSession {
  id            String   @id @default(uuid())
  buyerId       String
  
  // Requirements from questionnaire
  location      String?
  category      String?
  quantity      String?
  budget        String?
  
  // Status
  status        String   @default("active") // active, completed
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  buyer         Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id          String      @id @default(uuid())
  sessionId   String
  role        String      // user, assistant
  content     String
  
  // For supplier results
  hasSuppliers Boolean    @default(false)
  supplierIds  String[]   // Array of supplier IDs shown
  
  createdAt   DateTime    @default(now())

  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model SavedSupplier {
  id          String   @id @default(uuid())
  buyerId     String
  supplierId  String
  notes       String?
  savedAt     DateTime @default(now())

  // Relations
  buyer       Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@unique([buyerId, supplierId])
  @@map("saved_suppliers")
}

model SupplierContactLog {
  id          String   @id @default(uuid())
  buyerId     String
  supplierId  String
  sessionId   String?  // Which chat session this came from
  viewedAt    DateTime @default(now())

  // Relations
  buyer       Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@map("supplier_contact_logs")
}

// ============================================
// INQUIRY & QUOTE MODELS
// ============================================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  inquiries   Inquiry[]

  @@map("categories")
}

model Inquiry {
  id          String   @id @default(uuid())
  buyerId     String
  supplierId  String?  // Matched supplier
  categoryId  String?
  
  // Inquiry Details
  product     String
  description String?
  quantity    String
  budget      String?
  timeline    String?
  
  // Status
  status      String   @default("new") // new, quoted, accepted, rejected, closed
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  buyer       Buyer    @relation(fields: [buyerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  category    Category? @relation(fields: [categoryId], references: [id])
  quotes      Quote[]

  @@map("inquiries")
}

model Quote {
  id          String   @id @default(uuid())
  inquiryId   String
  supplierId  String
  
  // Quote Details
  price       String
  moq         String?
  timeline    String?
  notes       String?
  
  // Status
  status      String   @default("submitted") // submitted, accepted, rejected
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  inquiry     Inquiry  @relation(fields: [inquiryId], references: [id])
  supplier    Supplier @relation(fields: [supplierId], references: [id])

  @@map("quotes")
}

// ============================================
// RATING MODEL
// ============================================

model SupplierRating {
  id          String   @id @default(uuid())
  supplierId  String
  buyerId     String
  rating      Int      // 1-5 stars
  review      String?
  createdAt   DateTime @default(now())
  
  // Relations
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  buyer       Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  @@unique([supplierId, buyerId])
  @@map("supplier_ratings")
}
